name: genre-classification

on: 
  push:
    branches: 
      - dev

jobs:
  build: # nombre del job
    runs-on: [ubuntu-20.04] # latest
    container: alangrosso/cml-conda:latest
    
    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v2
      
      - name: Setup NodeJS 16
        uses: actions/setup-node@v2
        with:
          node-version: 16

      - name: cml-run
        env:
          repo_token: ${{ secrets.ML_PIPELINE_GITHUB_TOKEN }}
        run: |
          sudo apt-get update
          export HYDRA_FULL_ERROR=1
          pip3 install pandas==1.5.3 numpy==1.23.5 mlflow==2.2.0 hydra-core==1.3.2 hydra-joblib-launcher==1.2.0
          mlflow run 04-pipeline-ml-ci-cd/.

          echo "## Model metrics" > report.md
          cat ./evaluate/metrics.txt >> report.md

          echo "## Confusion Matrix Test Dataset" >> report.md

          cml-publish ./evaluate/img/confusion_matrix.png --md >> report.md
          #cml-publish residuals.png --md >> report.md

          cml-send-comment report.md