name: genre-classification

on: 
  push:
    branches: 
      - dev

jobs:
  build: # nombre del job
    runs-on: [ubuntu-20.04] # latest
    container: alangrosso/cml-conda:latest
    
    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v2
      
      - name: Setup NodeJS 16
        uses: actions/setup-node@v2
        with:
          node-version: 16

      - name: cml-run
        env:
          repo_token: ${{ secrets.ML_PIPELINE_GITHUB_TOKEN }}
        run: |
          # sudo apt-get update
          export HYDRA_FULL_ERROR=1
          pip3 install pandas==1.2.3 numpy==1.16.5 mlflow==1.26.0
          mlflow run 04-pipeline-ml-ci-cd/.
          # mlflow run 04-pipeline-ml-ci-cd/. -P hydra_options="-m random_forest_pipeline.random_forest.n_estimators=60,80 random_forest_pipeline.random_forest.max_depth=range(3,11,4) random_forest_pipeline.random_forest.min_samples_split=15,30"

          echo "## Model metrics" > report.md
          cat ./evaluate/metrics.txt >> report.md

          echo "## Confusion Matrix Test Dataset" >> report.md

          cml-publish ./evaluate/img/confusion_matrix.png --md >> report.md
          #cml-publish residuals.png --md >> report.md

          cml-send-comment report.md